# 秒杀系统

https://osjobs.net/system/posts/spike-system/

1. 描述系统特点

大流量和流量倾斜，大量的流量会集中在少量的部分商品中。

2. 秒杀系统需要保证

   - 高可用，服务器不因为大流量而崩溃，同时秒杀业务不影响其他业务
   - 高扩展，在特殊活动之前能够水平扩容
   - 一致性，商品不能出现超卖或者少卖的问题

3. 方案

   - 使用消息队列

   - 前后端流量限制：

     - 前端限流包括验证答题，防止重复点击按钮等机制
     - 后端限流使用限流算法进行流量限制，此外还需要注意，客户可能会出现支付超时导致释放库存的情况，系统需要通知限流器接受新的请求。

   - 负载均衡，路由将下单请求通过负载均衡转发到最合适的服务器。

   - 安全校验：

     - 前端安全校验：客户端账户验证（确保客户有资格参考秒杀活动），客户端版本安全验证（防止反编译以及修改客户端代码），**秒杀接口动态生成（防止使用刷单脚本）**等机制。
     - 后端安全校验：黑名单校验，ip地址校验等机制。

   - 处理热门资源：

     - 静态识别：包括京东在内的一些电商平台，客户在参加秒杀活动之前需要先进行预约，只有预约过的客户才能参考秒杀活动。这样系统可以提早识别热门商品以及进行流量预估。
     - 动态识别：通过实时数据分析系统在秒杀活动前统计出现在较多客户浏览的热门商品，针对预估结果进行资源分配。

   - 隔离热门资源，设置独立的策略：

     - 使用特殊的限流器，由于秒杀系统的库存很少，在下单一开始阶段就可以随机丢弃大部分请求。
     - 使用单独的数据库，我们可以对热门商品进行分库分表，这样可以将请求处理的压力分摊到多个数据库中。

     ![资源隔离](https://cdn.jsdelivr.net/gh/OSJobs/osjobs-system/static/spike/%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB.svg)

![架构3](https://cdn.jsdelivr.net/gh/OSJobs/osjobs-system/static/spike/%E6%9E%B6%E6%9E%843.svg)

### 面试回答

方案：

要保证上述三个性质，主要方案有三个：

- 合理使用消息队列，既可以解决并发安全问题，也可以进行业务解耦，方便水平扩展。
- 前后端的流量限制，将大部分的无效流量拦在服务器之前。
- 热门资源隔离，针对热门商品进行独立处理以及资源分配。
- 缓存预刷

###### “对秒杀商品进行分库分表之后可能导致某个分表库存为零，但其他分表还有库存，如何解决这个问题？”

- 通过路由组件记录每个分表的库存情况，将下单请求转发到有库存的分表中。

###### “客户下单后可能支付超时并释放库存，这时候有哪些要注意的？”

- 服务器能够通知限流器以及前端库存发生变化，限流器能够重新接收请求，前端页面显示可下单的页面，确保后续的用户能继续购买商品。

###### “消息队列方案有什么潜在问题吗？”

“秒杀系统下，可能 80% 的流量都指向同一个热门商品，那么消息队列中的分区会特别大，影响了两个方面 1）消息队列本身的稳定性，吞吐量会受单个分区限制，也可能影响其他业务。2）下单请求受到消费者消费能力的限制，即使消息队列每秒可以处理大量消息，但是数据库每秒处理的数量有限。可以使用以下几种方案：

- 压力测试：在前期压力测试的时候，模拟流量极端分布的情况，优化系统架构，确保现有架构能够支持服务。

- 资源隔离：对秒杀商品使用独立的消息队列，使用特殊的流量限流策略，配置更好的资源。

###### “消息队列怎么保证消息有且仅生效一次（Exactly Once）？”

- 为了保证最少一次生效, 消费者需要下单成功后才能返回确认 ACK，而不是消息被消费者接收时候就ack，否则有可能会丢失消息。
- 为了防止消息重复消费的问题，需要使下单逻辑变为幂等操作，常见的解决方案是保证下单请求有全局唯一的 ID，并在消息队列中对 ID 进行持久化，在发送给消费者之前先检查 ID 是否已经消费过。要注意中间层的重试机制不要修改这个全局唯一的 ID，不然会导致消息队列误以为该消息没有消费过。

###### 分布式锁和数据库悲观锁相比有什么优势？有什么共同的缺点？”

- 优点：**加锁的操作不依赖Mysql数据库**，降低数据库资源冲突的概率和压力。**
- 共同缺点：会降低性能，对于单个商品都是串行操作，假如每个订单执行要 100ms，每秒只能执行 10 个对应的订单，可能会出现大量请求阻塞的情况。

###### “如果电商系统流量过大，如何进行降级服务？”

暂停非核心业务：例如淘宝在双十一会暂时关闭退款功能。

拒绝服务：当系统压力到达一个阈值的的时候，随机丢弃部分秒杀请求。

减少重试：将重试次数降低甚至设置为0，否则容易造成雪崩效应，系统陷入负反馈循环，无法正常恢复。

###### 你的方案还有哪些可以优化的地方

根据业务的实际情况，比如读写比例，比如对于BI来说最核心的最频繁的是读请求，优化读取的性能，使用缓存。

