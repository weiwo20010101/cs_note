# TinyURL设计

## 需求

功能：

1. 用户应该能够从原始URL生成一个缩短的URL
2. 短链接应将用户重定向到原始链接
3. 用户应该可以选择为其URL提供自定义短链接

设计目标：

- 高可用，如果系统出现故障，则意味着所有的短链接都无法正常工作
- URL重定向应该以最小的延迟实时发生
- 缩短的链接不应以任何方式预测

拓展可选目标

- 该服务应该可以通过RESTAPI访问
- 分析：URL被访问了多少次
- 用户应该能够制定URL的过期时间



## 编码方式

要生成唯一的短URL，我们可以使用原始URl的唯一哈希（md5，sha256）等计算它，然后使用base62进行编码。如果我们使用md5算法作为我们的哈希函数，它将产生一个128位的哈希值，经过base62编码后，我们会得到一个超过7个字符的字符串，我们可以将前7个字符作为密钥。

我们可能会为一个短 URL 获得相同的唯一 ID，这可能会导致数据损坏。所以我们需要执行一些检查以确保数据库中不存在这个唯一 ID。

这种可能导致冲突：解决方法就是对一个计数器进行编码。关于这个计数器，可以采用分布式id生成算法，比如雪花算法，借助zk部署一个单独的集群用于生产计数。

## 高可用-数据库

选择NoSQL数据库

我们可以使用使用 ACID 属性的 RDBMS，但您将面临关系数据库的可伸缩性问题。现在，如果您认为可以使用分片来解决 RDBMS 中的可伸缩性问题，那么这将增加系统的复杂性。有 3000 万活跃用户，因此会有转换和大量短 URL 解析和重定向。对于这 3000 万用户来说，读写将很繁重，因此当我们希望以分布式方式拥有我们的系统时，使用分片扩展 RDBMS 将增加设计的复杂性。在 RDBMS 的情况下，您可能必须使用一致性哈希来平衡流量和数据库查询，这是一个复杂的过程。因此，要处理我们系统上如此庞大的流量，关系数据库是不合适的，而且扩展 RDBMS 也不是一个好的决定。 
**现在我们来谈谈 NoSQL！**

使用 NoSQL 数据库的唯一问题是它的最终一致性。我们写了一些东西，复制到不同的节点需要一些时间，但我们的系统需要高可用性，而 NoSQL 符合这个要求。NoSQL 可以轻松处理 3000 万活跃用户，并且易于扩展。当我们想要扩展存储时，我们只需要不断添加节点。 

## 可拓展 

对于可扩展的解决方案，使用计数器是一个不错的决定，因为计数器总是会递增，因此我们可以为每个新请求获得一个新值。 

**单服务器方法：** 

- 单个主机或服务器（比如数据库）将负责维护计数器。
- 当工作主机收到请求时，它会与计数器主机对话，计数器主机返回一个唯一的数字并递增计数器。当下一个请求到来时，计数器主机再次返回唯一编号，然后继续。
- 每个工作主机都有一个唯一的编号，用于生成 TinyURL。

**问题：**如果计数器主机宕机一段时间就会产生问题，而且如果请求数量很高，那么计数器主机可能无法处理负载。所以挑战是单点故障和单点瓶颈。 

*如果有多个服务器怎么办？* 

您无法维护单个计数器并将输出返回给所有服务器。为了解决这个问题，我们可以为使用不同计数器范围的多个服务器使用多个内部计数器。例如服务器1的范围是1到1M，服务器2的范围是1M到10M，依此类推。但是我们将再次面临一个问题，即如果其中一个计数器出现故障，那么对于另一台服务器，将很难获得故障计数器的范围并再次维护它。此外，如果一个计数器达到其最大限制，则重置计数器将很困难，因为没有单个主机可用于协调所有这些多台服务器。由于我们不知道哪个服务器是主服务器或哪个服务器是从服务器以及哪个服务器负责协调和同步，因此架构将变得混乱。 

**解决方案：**为了解决这个问题，我们可以使用分布式服务 Zookeeper 来管理所有这些繁琐的任务，并解决分布式系统的各种挑战，如竞争条件、死锁或数据的粒子故障。Zookeeper 基本上是一种管理大量主机的分布式协调服务。它跟踪所有的事情，例如服务器的命名、活动服务器、死服务器以及所有主机的配置信息。它提供协调并保持多个服务器之间的同步。 
让我们讨论如何使用 Zookeeper 为分布式主机维护一个计数器。 
 

![Zookeeper 高级架构](https://media.geeksforgeeks.org/wp-content/cdn-uploads/20210214204810/Zookeeper-URL-Shortening-Service.png)

- 从 3.5 万亿个组合中提取第 10 亿个组合。
- 在 Zookeeper 中维护范围并将第 10 亿划分为 1000 个范围，每个范围为 100 万，即范围 1->(1 – 1,000,000)，范围 2->(1,000,001 – 2,000,000)…。范围 1000->(999,000,001 – 1,000,000,000)
- 当添加服务器时，这些服务器将向 Zookeeper 请求未使用的范围。假设 W1 服务器被分配范围 1，现在 W1 将生成递增计数器并使用编码技术的微小 URL。每次它都是一个唯一的数字，所以没有冲突的可能性，也没有必要继续检查数据库以确保 URL 已经存在或不存在。我们可以直接将长URL和短URL的映射插入到DB中。
- 在最坏的情况下，如果其中一台服务器出现故障，那么我们只会在 Zookeeper 中丢失一百万个组合（这些组合将不会被使用，我们也不能重用它）但是因为我们有 3.5 万亿个组合，所以我们不应该担心丢失这个组合。
- 如果其中一台服务器将达到其最大范围或限制，那么它可以再次从 Zookeeper 获取新的范围。
- 添加新服务器也很容易。Zookeeper 将为这个新服务器分配一个未使用的计数器范围。
- 当第一个十亿耗尽时，我们将拿出第二个十亿来继续这个过程。

zk维护节点（服务器）元数据信息。

## 表设计

![image-20230225020532452](/Users/bytedance/Library/Application Support/typora-user-images/image-20230225020532452.png)

## 优化

1. 缓存，lru缓存。
2. 负载均衡，选择负载均衡算法。

## 架构图

![image-20230225020715484](/Users/bytedance/Library/Application Support/typora-user-images/image-20230225020715484.png)