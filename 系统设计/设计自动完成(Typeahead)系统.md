# 设计自动完成(Typeahead)系统

## 功能要求

我们的服务应该提供以用户当前键入的查询开头的前10个术语，根据短语和查询的频率和最近程度对建议进行排序。这意味着与用户输入匹配的最常用和最近使用的术语将在建立列表中优先显示。

## 非功能要求

1. 高可用性，系统应该能够处理中断并且继续运行而不会出现严重停机
2. 实时建议，用户应该能够在近乎即时的时间内看到建议，目标是在200毫秒以内
3. 可拓展型，系统应该能够处理大量流量而不会遇到性能问题

## api

1. Get_suggestions(prefix)
2. add to db(query)

## 数据结构

前缀树。

## 如何提升优化

1. 空间换时间，保存每个节点的前10名建议，更新的时候从下向上更新到根节点，检查当前查询是否在每个父节点的前10名中，如果是我们将相应地调整频率，如果不在，将检查它是否具有足够高的频率以被包含，如果是这样，我们将添加新短语并且删除频率最低的术语。
2. 限制查询的频率次数，比如只有不少于10次的查询才会被记录并且推荐
3. 避免在每个查询上更新trie，在设定的时间段后离线更新trie，定期处理所有日志记录数据，可以设置一个Map-Reduce作业，每个小时运行一次这个MR作业，计算前一个小时搜索的所有术语的频率，根据此信息更新trie。可以使用分布式一致性算法raft，保证数据在各个服务器上的强一致性

## 删除的方法

1. 从trie中完全删除违规短语，感觉不是很建议，可以用于新添加的违规短语，把历史的有关记录删除掉
2. 添加一个过滤层，没有什么是添加一层解决不了的。

## 排名标准

不仅仅是简单的计数，还必须考虑其他标准。例如新鲜度，用户位置，语言，人口统计，个人历史。

## 缓存

## 数据库分区

方法一：按照第一个字母分区，这样会导致分区不均匀，一些服务器处理的流量明显多于其他的

方法二：使用散列函数，负载分布更加均匀，但是查询的时候要向所有服务器发送查询以完成完整的建议列表，这会增加延迟。

因此可以考虑第一种

## 复制和负载均衡

## 容错